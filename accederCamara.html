<!DOCTYPE html>
<html>
  <head>
    <title>Identificación de Objetos</title>
    <meta charset="UTF-8">
    <style>
        body {
            background-color: #ffffff;
        }
		/*Rotar imagen horizontalmente*/
		#foto{
			-moz-transform: scaleX(-1);
			-o-transform: scaleX(-1);
			-webkit-transform: scaleX(-1);
			transform: scaleX(-1);
			-ms-filter: "FlipH";
			filter: FlipH;
		}
    </style>
    <script type="text/javascript">
		//Temporizador que inica al cargar la pagina
		var temporizador=setInterval(function(){capturarImagen();},500);
		
		//Función para saber si el navegador 
		//soporta la API getUserMedia
        function soportaUserMedia() {
            navigator.getUserMedia = navigator.getUserMedia || // Opera
                navigator.webkitGetUserMedia || // Chrome, Safari
                navigator.mozGetUserMedia || // Mozilla
                navigator.msGetUserMedia;
            if (navigator.getUserMedia) {
                return true
            }
            return false;
        } 
		
        function hasURL() {
            window.URL = window.URL || window.webkitURL
                || window.mozURL || window.msURL;
            if (window.URL && window.URL.createObjectURL) {
                return true;
            }
            return false;
        } 
		
        function error(e) {
            alert("Fallo en la aplicación. "+e);
        }
		
        function setStream(stream) {
            var webcam = document.getElementById("webcam");
            webcam.src = window.URL.createObjectURL(stream);
            webcam.play();
        }
		
        function onLoad () {
            if (!soportaUserMedia() || !hasURL()) {
                alert("Tu navegador no soporta getUserMedia()");
            } else {
                navigator.getUserMedia(
                    {video: true, audio: false},
                    setStream,
                    error
                );
            }
        } 
		
		function capturarImagen(){
			var Camara, Foto, contextFoto, ancho, alto;
			Camara = document.getElementById('webcam');
			Foto = document.getElementById('foto');
			ancho = 300;// Camara.width;
			alto = 300;//Camara.height;
			Foto.width=ancho;
			Foto.height=alto;
			contextFoto = Foto.getContext('2d');
			contextFoto.drawImage(Camara, 0, 0, ancho, alto);
			buscarHoja(contextFoto);
		}
		
		function buscarHoja(imagen){
			var j=0;
			var promePX=0;
			var segmento= new Array();
			var ilumina =Iluminacion(imagen);
			var infoLuz= document.getElementById("info");
			var intensidad=ilumina.split(':');
			info.innerHTML=ilumina;
			//creamos un vector con los pixeles de la imagen.
			vectImagen = imagen.getImageData(0,0,300,300);
			
			for (var i=3;i<vectImagen.data.length;i+=4){
				//Se suman todos los bytes de cada canal (RGB)
				//Para luego sacar el promedio
				promePX=(vectImagen.data[i-3]+vectImagen.data[i-2]+vectImagen.data[i-1])/3;
				if (promePX>5 && promePX<=140){
					//los puntos más oscuros los coloca de color verde
					/*vectImagen.data[i-3]=0;
					vectImagen.data[i-2]=255;
					vectImagen.data[i-1]=0;	*/
				}
				//Busca los pixeles más claros (La Hoja)
				switch (parseInt(intensidad[0])){
					case 1:
						if (promePX>100 && promePX<=150){
							vectImagen.data[i-3]=255;
							vectImagen.data[i-2]=0;
							vectImagen.data[i-1]=0;
						}
						break;
					case 2:
						if (promePX>130 && promePX<=180){
							vectImagen.data[i-3]=255;
							vectImagen.data[i-2]=0;
							vectImagen.data[i-1]=0;
						}
						break;
					case 3:
						if (promePX>160 && promePX<=210){
							vectImagen.data[i-3]=255;
							vectImagen.data[i-2]=0;
							vectImagen.data[i-1]=0;
						}
						break;
				}
				if (promePX>140 && promePX<=255){
					//los puntos m�s claros los coloca de color rojo
					/*vectImagen.data[i-3]=255;
					vectImagen.data[i-2]=0;
					vectImagen.data[i-1]=0;*/
					/*segmento[j]=i-3;j++;
					segmento[j]=i-2;j++;
					segmento[j]=i-1;j++;*/
					//Busca los pixeles más oscuros (La Marca)
					/*while (true){
						i+=4;
						promePX=(vectImagen.data[i-3]+vectImagen.data[i-2]+vectImagen.data[i-1])/3;
						if (promePX>5 && promePX<=140){
							//los puntos más claros los coloca de color rojo
							vectImagen.data[i-3]=0;
							vectImagen.data[i-2]=255;
							vectImagen.data[i-1]=0;			
						}else{
							break;
						}
					}*/
				
				}
				
			}
			imagen.putImageData(vectImagen, 0, 0);
			//buscarMarca(imagen,segmento);
		}
		
		function buscarMarca(imagen,segmento){
			var promePX=0;
			var j=0;
			//creamos un vector con los pixeles de la imagen.
			vectImagen = imagen.getImageData(0,0,300,300);
			for (var i=2;i<segmento.length;i+=3){
				//Se suman todos los bytes de cada canal (RGB)
				//Para luego sacar el promedio
				j=segmento[i];
				promePX=(vectImagen.data[j-3]+vectImagen.data[j-2]+vectImagen.data[j-1])/3;
				//Busca los pixeles más claros
				//Trata de encontrar la retina del ojo
				if (promePX>5 && promePX<=140){
					//los puntos m�s claros los coloca de color rojo
					vectImagen.data[j-3]=0;
					vectImagen.data[j-2]=255;
					vectImagen.data[j-1]=0;			
				}
			}
			imagen.putImageData(vectImagen, 0, 0);
		}
		
		function Iluminacion(imagen){
			var acumula=0;
			var puntos=0;
			//creamos un vector con los pixeles de la imagen.
			vectImagen = imagen.getImageData(0,0,300,300);
			for (i=200;i<vectImagen.data.length;i+=200){
					acumula+=vectImagen.data[i+1];puntos++;acumula+=vectImagen.data[i+5];puntos++;acumula+=vectImagen.data[i+9];puntos++;acumula+=vectImagen.data[i+13];puntos++;acumula+=vectImagen.data[i+17];puntos++;acumula+=vectImagen.data[i+21];puntos++;acumula+=vectImagen.data[i+25];puntos++;acumula+=vectImagen.data[i+29];puntos++;acumula+=vectImagen.data[i+33];puntos++;acumula+=vectImagen.data[i+37];puntos++;acumula+=vectImagen.data[i+41];puntos++;acumula+=vectImagen.data[i+45];puntos++;acumula+=vectImagen.data[i+49];puntos++;acumula+=vectImagen.data[i+53];puntos++;acumula+=vectImagen.data[i+57];puntos++;acumula+=vectImagen.data[i+61];puntos++;acumula+=vectImagen.data[i+65];puntos++;acumula+=vectImagen.data[i+69];puntos++;acumula+=vectImagen.data[i+73];puntos++;acumula+=vectImagen.data[i+77];puntos++;acumula+=vectImagen.data[i+81];puntos++;acumula+=vectImagen.data[i+85];puntos++;acumula+=vectImagen.data[i+89];puntos++;acumula+=vectImagen.data[i+93];puntos++;acumula+=vectImagen.data[i+97];puntos++;acumula+=vectImagen.data[i+101];puntos++;acumula+=vectImagen.data[i+105];puntos++;acumula+=vectImagen.data[i+109];puntos++;acumula+=vectImagen.data[i+113];puntos++;acumula+=vectImagen.data[i+117];puntos++;acumula+=vectImagen.data[i+121];puntos++;acumula+=vectImagen.data[i+125];puntos++;acumula+=vectImagen.data[i+129];puntos++;acumula+=vectImagen.data[i+133];puntos++;acumula+=vectImagen.data[i+137];puntos++;acumula+=vectImagen.data[i+141];puntos++;acumula+=vectImagen.data[i+145];puntos++;acumula+=vectImagen.data[i+149];puntos++;acumula+=vectImagen.data[i+153];puntos++;acumula+=vectImagen.data[i+157];puntos++;acumula+=vectImagen.data[i+161];puntos++;acumula+=vectImagen.data[i+165];puntos++;acumula+=vectImagen.data[i+169];puntos++;acumula+=vectImagen.data[i+173];puntos++;acumula+=vectImagen.data[i+177];puntos++;acumula+=vectImagen.data[i+181];puntos++;acumula+=vectImagen.data[i+185];puntos++;acumula+=vectImagen.data[i+189];puntos++;acumula+=vectImagen.data[i+193];puntos++;acumula+=vectImagen.data[i+197];puntos++;
			}
			var prome=parseInt(acumula/puntos);
			if (prome>40 && prome<=70) return "1: "+prome;
			if (prome>70 && prome<=100) return "2: "+prome;
			if (prome>100 && prome<=130) return "3: "+prome;
			if (prome>130 && prome<=160) return "4: "+prome;
			if (prome>160) return "5: "+prome;
		}
    </script>
  </head>
  <body onload="onLoad()">
  <canvas id="foto">
	  </canvas>
      <video id="webcam" >
          Tu navegador no es compatible con la etiqueta video de HTML5.
      </video>
	  <div id="info"></div>
  </body>
</html>
